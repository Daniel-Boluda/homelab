app-template:
  controllers:
    jellyplist:
      labels:
        backup/retain: quaterly
      type: statefulset
      containers:
        jellyplist:
          image:
            repository: ghcr.io/kamilkosek/jellyplist
            tag: v0.1.9

          env:
            TZ: Europe/Madrid
            JELLYFIN_SERVER_URL: https://pelis.dbcloud.org
            JELLYPLIST_DB_HOST: jellyplist-postgres #Hostname of the db Container
            MUSIC_STORAGE_BASE_PATH: '/music' # The base path where your music library is located. Must be the same value as your music library in jellyfin
          envFrom:
          - secretRef:
              name: jellyplist-secrets

          resources:
            requests:
              cpu: 500m
              memory: 1800Mi
            limits:
              memory: 4000Mi


    redis:
      containers:
        redis:
          image:
            repository: redis
            tag: 7.4.2

          command:
            - sh
          args:
            - -c
            - >-
              redis-server
          resources:
            requests:
              cpu: 23m
              memory: 64M
            limits:
              cpu: 500m
              memory: 64M

  service:
    jellyplist:
      controller: jellyplist
      ports:
        http:
          port: 8000
    
    redis:
      controller: redis
      ports:
        redis:
          enabled: true
          port: 6379

  ingress:
    jellyplist:
      enabled: true
      className: nginx-internal
      annotations:
        external-dns.alpha.kubernetes.io/enabled: "true"
        cert-manager.io/cluster-issuer: letsencrypt-prod-dns
      hosts:
      - host: &host jellyplist.internal.dbcloud.org
        paths:
        - path: /
          pathType: Prefix
          service:
            identifier: jellyplist
            port: http
      tls:
      - hosts:
        - *host
        secretName: jellyplist-tls-certificate

    external:
      enabled: true
      className: nginx-external
      annotations:
        external-dns.alpha.kubernetes.io/enabled: "true"
        external-dns.alpha.kubernetes.io/target: dbcloud.org
        cert-manager.io/cluster-issuer: letsencrypt-prod-dns
        nginx.ingress.kubernetes.io/auth-url: https://auth.dbcloud.org/oauth2/auth?allowed_groups=jellyplistUsers
        nginx.ingress.kubernetes.io/auth-signin: https://auth.dbcloud.org/oauth2/start
        nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
      hosts:
      - host: &host jellyplist.dbcloud.org
        paths:
        - path: /
          pathType: Prefix
          service:
            identifier: jellyplist
            port: http
      tls:
      - hosts:
        - *host
        secretName: jellyplist-external-tls-certificate

  defaultPodOptions:
    securityContext:
      runAsUser: 0
      runAsGroup: 0
      fsGroup: 0
      fsGroupChangePolicy: "OnRootMismatch"

  persistence:
    #data:
    #  enabled: true
    #  globalMounts:
    #  - path: /jellyplist
    #  existingClaim: data-jellyplist
    music:
      enabled: true
      type: hostPath
      hostPath: /datasets/music
      globalMounts:
      - path: /music
        readOnly: false