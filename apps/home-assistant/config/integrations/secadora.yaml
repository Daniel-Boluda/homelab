input_select:
  secadora_status:
    name: Estado secadora
    options:
      - Apagada
      - Standby
      - Secando
    icon: mdi:tumble-dryer

input_datetime:
  secadora_last_status_change:
    name: Último cambio de estado secadora
    has_date: true
    has_time: true

automation:
  - alias: Control completo secadora
    description: Maneja cambios de estado y notificaciones en una sola automatización
    mode: restart
    trigger:
      # --- Subida inmediata ---
      - platform: numeric_state
        entity_id: sensor.enchufe_secadora_relay_power
        above: 10
        id: "subir_secando"
      - platform: numeric_state
        entity_id: sensor.enchufe_secadora_relay_power
        above: 2
        below: 10
        id: "subir_standby"

      # --- Bajada con retardo ---
      - platform: numeric_state
        entity_id: sensor.enchufe_secadora_relay_power
        below: 10
        above: 2
        id: "bajar_secando_a_standby"
      - platform: numeric_state
        entity_id: sensor.enchufe_secadora_relay_power
        below: 2
        id: "bajar_standby_a_apagada"

      # --- Aviso standby 10 min ---
      - platform: state
        entity_id: input_select.secadora_status
        to: "Standby"
        for: "00:10:00"
        id: "aviso_standby_largo"

    condition: []
    action:
      - choose:
          # Subida a Secando (inmediata)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'subir_secando' }}"
            sequence:
              - service: input_select.select_option
                target:
                  entity_id: input_select.secadora_status
                data:
                  option: Secando
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.secadora_last_status_change
                data:
                  timestamp: "{{ now().timestamp() }}"

          # Subida a Standby (inmediata)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'subir_standby' }}"
            sequence:
              - service: input_select.select_option
                target:
                  entity_id: input_select.secadora_status
                data:
                  option: Standby
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.secadora_last_status_change
                data:
                  timestamp: "{{ now().timestamp() }}"

          # Bajada de Secando a Standby (2 min)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'bajar_secando_a_standby' and states('input_select.secadora_status') == 'Secando' }}"
            sequence:
              - delay: "00:02:00"
              - condition: numeric_state
                entity_id: sensor.enchufe_secadora_relay_power
                below: 10
                above: 2
              - service: input_select.select_option
                target:
                  entity_id: input_select.secadora_status
                data:
                  option: Standby
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.secadora_last_status_change
                data:
                  timestamp: "{{ now().timestamp() }}"
              - service: notify.send_message
                data:
                  message: "⚠️ La secadora ha terminado y está en standby."
                target:
                  device_id:
                    - 54e59c960e82f66b7a554608a8e30f28

          # Bajada de Standby a Apagada (2 min)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'bajar_standby_a_apagada' and states('input_select.secadora_status') == 'Standby' }}"
            sequence:
              - delay: "00:02:00"
              - condition: numeric_state
                entity_id: sensor.enchufe_secadora_relay_power
                below: 2
              - service: input_select.select_option
                target:
                  entity_id: input_select.secadora_status
                data:
                  option: Apagada
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.secadora_last_status_change
                data:
                  timestamp: "{{ now().timestamp() }}"

          # Aviso si standby más de 10 min
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'aviso_standby_largo' }}"
            sequence:
              - service: notify.send_message
                data:
                  message: "⏳ La secadora lleva más de 10 minutos en standby."
                target:
                  device_id:
                    - 54e59c960e82f66b7a554608a8e30f28
