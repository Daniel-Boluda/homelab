automation:
  - alias: Avisos Telegram - Puertas, Ventanas y Fugas
    description: Notifica por Telegram (con foto al abrir la puerta de entrada)
    mode: single

    trigger:
      # --- Puerta entrada ---
      - platform: state
        entity_id: binary_sensor.puerta_entrada
        from: "off"
        to: "on"
        id: puerta_entrada_abierta
      - platform: state
        entity_id: binary_sensor.puerta_entrada
        from: "on"
        to: "off"
        id: puerta_entrada_cerrada

      # --- Puerta terraza ---
      - platform: state
        entity_id: binary_sensor.puerta_terraza_contact
        from: "off"
        to: "on"
        id: puerta_terraza_abierta
      - platform: state
        entity_id: binary_sensor.puerta_terraza_contact
        from: "on"
        to: "off"
        id: puerta_terraza_cerrada

      # --- Puerta cocina ---
      - platform: state
        entity_id: binary_sensor.puerta_cocina_contact
        from: "off"
        to: "on"
        id: puerta_cocina_abierta
      - platform: state
        entity_id: binary_sensor.puerta_cocina_contact
        from: "on"
        to: "off"
        id: puerta_cocina_cerrada

      # --- Ventana despacho ---
      - platform: state
        entity_id: binary_sensor.ventana_despacho_contact
        from: "off"
        to: "on"
        id: ventana_despacho_abierta
      - platform: state
        entity_id: binary_sensor.ventana_despacho_contact
        from: "on"
        to: "off"
        id: ventana_despacho_cerrada

      # --- Ventana dormitorio ---
      - platform: state
        entity_id: binary_sensor.ventana_dormitorio_contact
        from: "off"
        to: "on"
        id: ventana_dormitorio_abierta
      - platform: state
        entity_id: binary_sensor.ventana_dormitorio_contact
        from: "on"
        to: "off"
        id: ventana_dormitorio_cerrada

      # --- Ventana invitados ---
      - platform: state
        entity_id: binary_sensor.ventana_invitados_contact
        from: "off"
        to: "on"
        id: ventana_invitados_abierta
      - platform: state
        entity_id: binary_sensor.ventana_invitados_contact
        from: "on"
        to: "off"
        id: ventana_invitados_cerrada

      # --- Fugas baÃ±o ---
      - platform: state
        entity_id: binary_sensor.fugas_bano_water_leak
        from: "off"
        to: "on"
        id: fuga_bano_detectada
      - platform: state
        entity_id: binary_sensor.fugas_bano_water_leak
        from: "on"
        to: "off"
        id: fuga_bano_resuelta

      # --- Fugas aseo ---
      - platform: state
        entity_id: binary_sensor.fugas_aseo_water_leak
        from: "off"
        to: "on"
        id: fuga_aseo_detectada
      - platform: state
        entity_id: binary_sensor.fugas_aseo_water_leak
        from: "on"
        to: "off"
        id: fuga_aseo_resuelta

    action:
      - choose:
          # ------- Puerta entrada abierta: mensaje + foto -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'puerta_entrada_abierta' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Puerta entrada"
                  message: "ðŸšª La PUERTA DE ENTRADA se ha ABIERTO a las {{ now().strftime('%H:%M:%S') }}."
              - service: telegram_bot.send_photo
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  caption: "ðŸ“· DetecciÃ³n cÃ¡mara descansillo"
                  file: /api/image_proxy/image.camara_descansillo_person

          # ------- Puerta entrada cerrada -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'puerta_entrada_cerrada' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Puerta entrada"
                  message: "ðŸšª La PUERTA DE ENTRADA se ha CERRADO a las {{ now().strftime('%H:%M:%S') }}."

          # ------- Puerta terraza -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'puerta_terraza_abierta' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Puerta terraza"
                  message: "ðŸšª La PUERTA DE LA TERRAZA se ha ABIERTO."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'puerta_terraza_cerrada' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Puerta terraza"
                  message: "ðŸšª La PUERTA DE LA TERRAZA se ha CERRADO."

          # ------- Puerta cocina -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'puerta_cocina_abierta' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Puerta cocina"
                  message: "ðŸšª La PUERTA DE LA COCINA se ha ABIERTO."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'puerta_cocina_cerrada' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Puerta cocina"
                  message: "ðŸšª La PUERTA DE LA COCINA se ha CERRADO."

          # ------- Ventana despacho -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'ventana_despacho_abierta' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Ventana despacho"
                  message: "ðŸªŸ La VENTANA DEL DESPACHO se ha ABIERTO."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'ventana_despacho_cerrada' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Ventana despacho"
                  message: "ðŸªŸ La VENTANA DEL DESPACHO se ha CERRADO."

          # ------- Ventana dormitorio -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'ventana_dormitorio_abierta' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Ventana dormitorio"
                  message: "ðŸªŸ La VENTANA DEL DORMITORIO se ha ABIERTO."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'ventana_dormitorio_cerrada' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Ventana dormitorio"
                  message: "ðŸªŸ La VENTANA DEL DORMITORIO se ha CERRADO."

          # ------- Ventana invitados -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'ventana_invitados_abierta' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Ventana invitados"
                  message: "ðŸªŸ La VENTANA DE INVITADOS se ha ABIERTO."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'ventana_invitados_cerrada' }}"
              - condition: template
                value_template: "{{ states('zone.home') | int(0) == 0 }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Ventana invitados"
                  message: "ðŸªŸ La VENTANA DE INVITADOS se ha CERRADO."

          # ------- Fuga baÃ±o -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'fuga_bano_detectada' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "ðŸš¨ FUGA EN BAÃ‘O"
                  message: "ðŸ’§ Se ha DETECTADO una FUGA DE AGUA en el BAÃ‘O."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'fuga_bano_resuelta' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Fuga baÃ±o resuelta"
                  message: "âœ… La fuga en el BAÃ‘O ya no se detecta."

          # ------- Fuga aseo -------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'fuga_aseo_detectada' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "ðŸš¨ FUGA EN ASEO"
                  message: "ðŸ’§ Se ha DETECTADO una FUGA DE AGUA en el ASEO."
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'fuga_aseo_resuelta' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  config_entry_id: 01K0ERS1J1REVPTMSB2J7S90QS
                  target: [-4214392892]
                  title: "Fuga aseo resuelta"
                  message: "âœ… La fuga en el ASEO ya no se detecta."
