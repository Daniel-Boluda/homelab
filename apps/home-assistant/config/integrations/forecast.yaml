template:
  - trigger:
      - platform: time
        at:
          - '18:00:00'
      # for debug
      # - platform: homeassistant
      #   event: start
    sensor:
      - name: Forecast lowest temperature 5 days
        unit_of_measurement: "°C"
        state: >
          {% set start = now().replace(hour=0,minute=0,second=0, microsecond=0) %}
          {% set end = (start + timedelta(days=5)) %}
          {% set start_str = start.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
          {% set end_str = end.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
          {{ state_attr('weather.forecast_home', 'forecast') | selectattr('datetime', '>=', start_str) | selectattr('datetime','<=', end_str) | map(attribute='templow') | list | min }}

automation:
  alias: Frost Forecast
  description: >-
    Checks the forecast lowest temps for the next 5 days and notify if there are frost risk
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.forecast_lowest_temperature_5_days
  variables:
    min_temp: 2
  condition:
    - "{{ states('sensor.forecast_lowest_temperature_5_days') | int < min_temp }}"
  action:
    - service: notify.all
      data:
        title: Frost is forecast!
        message: |
          Days below {{ min_temp }} °C:
          {%- for day in state_attr('weather.forecast_home', 'forecast') | selectattr('templow', '<', min_temp) %}
          {{ as_datetime(day.datetime).strftime('%m-%d')  }} - Lowest temperature: {{ day.templow }}
          {%- endfor %}
