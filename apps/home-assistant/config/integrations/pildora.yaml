input_boolean:
  tomar_pildora:
    name: Tomar píldora
    icon: mdi:pill

automation:

  # 0. Reset diario del estado a las 02:00
  - alias: "Reset diario del booleano de píldora"
    trigger:
      - platform: time
        at: "02:00:00"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.tomar_pildora

  # 1. Notificar a diario a las 13:30
  - alias: "Recordatorio inicial: Tomar píldora"
    trigger:
      - platform: time
        at: "13:30:00"
    action:
      - service: notify.mobile_app_iphone_de_lucia
        data:
          title: "Hora de tomar tu píldora"
          message: "¿Ya tomaste tu píldora?"
          data:
            actions:
              - action: "PILDORA_TOMADA"
                title: "Ya la tomé"
              - action: "RECORDAR_LUEGO"
                title: "Recuérdame en 15 min"

  # 2. Marcar como tomada si responde desde la notificación
  - alias: "Píldora marcada como tomada"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "PILDORA_TOMADA"
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.tomar_pildora
      - service: notify.mobile_app_iphone_de_lucia
        data:
          message: "✅ Píldora marcada como tomada."
      - service: notify.mobile_app_sm_a256b
        data:
          message: "✅ Lucia ha tomado la pildora."

  # 3. Repetir recordatorio cada 15 min hasta las 18:00 si no se ha tomado
  - alias: "Recordatorio recurrente píldora"
    trigger:
      - platform: time_pattern
        minutes: "/15"
    condition:
      - condition: time
        after: "13:30:00"
        before: "18:00:00"
      - condition: state
        entity_id: input_boolean.tomar_pildora
        state: "off"
    action:
      - service: notify.mobile_app_iphone_de_lucia
        data:
          title: "Recordatorio"
          message: "Aún no marcaste como tomada tu píldora."
          data:
            actions:
              - action: "PILDORA_TOMADA"
                title: "Ya la tomé"
              - action: "RECORDAR_LUEGO"
                title: "Recuérdame en 15 min"

  # 4. A las 18:00, si aún no se tomó, notificar también a Daniel
  - alias: "Aviso a Daniel si no se tomó píldora"
    trigger:
      - platform: time
        at: "18:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.tomar_pildora
        state: "off"
    action:
      - service: notify.mobile_app_iphone_de_lucia
        data:
          message: "⚠️ No marcaste como tomada la píldora hoy."
      - service: notify.mobile_app_sm_a256b
        data:
          message: "⚠️ [Nombre] no ha marcado como tomada su píldora hoy."

  # 5. Capturar “Recuérdame en 15 min” y disparar recordatorio único a los 15 min
  - alias: "Recordar píldora tras petición de Recordar más tarde"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "RECORDAR_LUEGO"
    action:
      # Esperamos 15 min desde que el usuario pulsa “Recuérdame en 15 min”
      - delay: "00:15:00"
      - condition:
          - condition: state
            entity_id: input_boolean.tomar_pildora
            state: "off"
      - service: notify.mobile_app_iphone_de_lucia
        data:
          title: "Recordatorio tardío"
          message: "Aún no has tomado tu píldora."
          data:
            actions:
              - action: "PILDORA_TOMADA"
                title: "Ya la tomé"
              - action: "RECORDAR_LUEGO"
                title: "Recuérdame en 15 min"
