input_boolean:
  pildora_lucia_taken:
    name: PÃ­ldora LucÃ­a tomada
    icon: mdi:pill

automation:
  - alias: "pildora Lucia GestiÃ³n completa"
    id: "pildora_lucia_gestion_completa"
    trigger:
      # 1) Reset diario a las 02:00
      - platform: time
        at: "02:00:00"
        id: "daily_reset"

      # 2) Cada 15 min (incluye 13:30, 13:45, â€¦, 18:00, 18:15, â€¦)
      - platform: time_pattern
        minutes: "/15"
        id: "every_15"

      # 3) Evento â€œYa la tomÃ©â€
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "PILDORA_TAKEN"
        id: "taken_event"

      # 4) Evento â€œNo puedo tomarlaâ€
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "CANNOT_TAKE"
        id: "cannot_event"

    action:
      - choose:
          # ---------- Bloque "daily_reset" ----------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'daily_reset' }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.pildora_lucia_taken
              - service: automation.turn_on
                target:
                  entity_id: automation.pildora_lucia_gestion_completa
              # Al resetear, nos aseguramos de que la misma automatizaciÃ³n
              # podrÃ¡ volver a enviar recordatorios tras las 02:00.

          # ---------- Bloque "every_15" para notificar a LucÃ­a entre 13:30 y 18:00 ----------
          - conditions:
              - condition: template
                value_template: >-
                  {{ 
                    trigger.id == 'every_15' and 
                    (now().hour > 13 or (now().hour == 13 and now().minute >= 30)) and 
                    now().hour < 24 and 
                    is_state('input_boolean.pildora_lucia_taken', 'off') 
                  }}
            sequence:
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  title: "Recordatorio: tomar pÃ­ldora"
                  message: "Â¿Ya tomaste tu pÃ­ldora?"
                  data:
                    actions:
                      - action: "PILDORA_TAKEN"
                        title: "Ya la tomÃ©"
                      - action: "CANNOT_TAKE"
                        title: "No puedo tomarla"

          # ---------- Bloque "every_15" para notificar a Daniel despuÃ©s de las 18:00 ----------
          - conditions:
              - condition: template
                value_template: >-
                  {{ 
                    trigger.id == 'every_15' and 
                    now().hour >= 18 and 
                    now().hour < 24 and
                    is_state('input_boolean.pildora_lucia_taken', 'off') 
                  }}
            sequence:
              - service: notify.mobile_app_sm_a256b
                data:
                  title: "Alerta: pÃ­ldora no tomada"
                  message: "LucÃ­a aÃºn no ha tomado su pÃ­ldora hoy."

          # ---------- Bloque "taken_event" (LucÃ­a pulsa â€œYa la tomÃ©â€) ----------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'taken_event' }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.pildora_lucia_taken
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  message: "âœ… Has marcado tu pÃ­ldora como tomada."
              - service: notify.mobile_app_sm_a256b
                data:
                  message: "âœ… Lucia ha tomado su pildora."

          # ---------- Bloque "cannot_event" (LucÃ­a pulsa â€œNo puedo tomarlaâ€) ----------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'cannot_event' }}"
            sequence:
              - service: automation.turn_off
                target:
                  entity_id: automation.pildora_lucia_gestion_completa
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  message: "ðŸ‘ Entendido, hoy no podrÃ¡s tomar tu pÃ­ldora. No recibirÃ¡s mÃ¡s recordatorios."
              - service: notify.mobile_app_sm_a256b
                data:
                  title: "Aviso: PÃ­ldora LucÃ­a"
                  message: "LucÃ­a ha indicado que no podrÃ¡ tomar su pÃ­ldora hoy."

        default: []

