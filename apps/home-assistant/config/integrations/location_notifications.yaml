input_boolean:
  lucia_guardia_nocturna:
    name: Lucía guardia nocturna
    icon: mdi:briefcase-clock

automation:
  - alias: Notificaciones ubicaciones clave con presencia
    mode: single
    trigger:
      - platform: zone
        entity_id: person.daniel_boluda_fdez_gmail_com
        zone: zone.supera_rivas
        event: enter
        id: "daniel_superarivas_enter"
      - platform: zone
        entity_id: person.pizarroservanlucia_gmail_com
        zone: zone.supera_rivas
        event: enter
        id: "lucia_superarivas_enter"
      - platform: zone
        entity_id: person.daniel_boluda_fdez_gmail_com
        zone: zone.home
        event: enter
        id: "daniel_home_enter"
      - platform: zone
        entity_id: person.pizarroservanlucia_gmail_com
        zone: zone.home
        event: enter
        id: "lucia_home_enter"
      - platform: numeric_state
        entity_id: zone.home
        below: 1
        id: "home_nobody"
      - platform: zone
        entity_id: person.pizarroservanlucia_gmail_com
        zone: zone.hospital_gomez_ulla
        event: enter
        id: "lucia_gomezulla_enter"
      - platform: zone
        entity_id: person.pizarroservanlucia_gmail_com
        zone: zone.hospital_gomez_ulla
        event: leave
        id: "lucia_gomezulla_leave"
      - platform: zone
        entity_id: person.daniel_boluda_fdez_gmail_com
        zone: zone.mercadona
        event: enter
        id: "daniel_mercadona_enter"
      - platform: zone
        entity_id: person.pizarroservanlucia_gmail_com
        zone: zone.mercadona
        event: enter
        id: "lucia_mercadona_enter"
      # Nuevo trigger: check guardia a la 01:00
      - platform: time
        at: "01:00:00"
        id: "check_lucia_guardia"

    action:
      - choose:
          # Daniel entra en Supera Rivas (notifica a Lucía si ella no está allí)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'daniel_superarivas_enter' }}"
              - condition: not
                conditions:
                  - condition: zone
                    entity_id: person.pizarroservanlucia_gmail_com
                    zone: zone.supera_rivas
            sequence:
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  title: "Ubicación"
                  message: "Daniel ha llegado a Supera Rivas."

          # Lucía entra en Supera Rivas (notifica a Daniel si él no está allí)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'lucia_superarivas_enter' }}"
              - condition: not
                conditions:
                  - condition: zone
                    entity_id: person.daniel_boluda_fdez_gmail_com
                    zone: zone.supera_rivas
            sequence:
              - service: notify.mobile_app_daniel_boluda
                data:
                  title: "Ubicación"
                  message: "Lucía ha llegado a Supera Rivas."

          # Daniel entra en casa (notifica a Lucía si ella no está en casa)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'daniel_home_enter' }}"
              - condition: not
                conditions:
                  - condition: zone
                    entity_id: person.pizarroservanlucia_gmail_com
                    zone: zone.home
            sequence:
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  title: "Ubicación"
                  message: "Daniel ha llegado a casa."

          # Lucía entra en casa (notifica a Daniel si él no está en casa)
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'lucia_home_enter' }}"
              - condition: not
                conditions:
                  - condition: zone
                    entity_id: person.daniel_boluda_fdez_gmail_com
                    zone: zone.home
            sequence:
              - service: notify.mobile_app_daniel_boluda
                data:
                  title: "Ubicación"
                  message: "Lucía ha llegado a casa."

          # Nadie en casa -> activar modo fuera
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'home_nobody' }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.modo_fuera_de_casa_stateful_scene

          # Lucía entra/sale del Hospital Gómez Ulla
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'lucia_gomezulla_enter' }}"
            sequence:
              - service: notify.mobile_app_daniel_boluda
                data:
                  title: "Ubicación"
                  message: "Lucía ha llegado al Hospital GU."

          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'lucia_gomezulla_leave' }}"
            sequence:
              - service: notify.mobile_app_daniel_boluda
                data:
                  title: "Ubicación"
                  message: "Lucía ha salido del Hospital GU."

          # Mercadona: al entrar uno, sugiere lista y avisa al otro si no está allí
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'daniel_mercadona_enter' }}"
            sequence:
              - service: notify.mobile_app_daniel_boluda
                data:
                  title: "Lista de la compra"
                  message: "¿Quieres abrir la lista de la compra?"
                  data:
                    url: "/shopping-list"
                    clickAction: "/shopping-list"
              - condition: not
                conditions:
                  - condition: zone
                    entity_id: person.pizarroservanlucia_gmail_com
                    zone: zone.mercadona
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  title: "Lista de la compra"
                  message: "Daniel está en Mercadona. ¿Quieres añadir algo?"
                  data:
                    url: "/shopping-list"
                    clickAction: "/shopping-list"

          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'lucia_mercadona_enter' }}"
            sequence:
              - service: notify.mobile_app_iphone_de_lucia
                data:
                  title: "Lista de la compra"
                  message: "¿Quieres abrir la lista de la compra?"
                  data:
                    url: "/shopping-list"
                    clickAction: "/shopping-list"
              - condition: not
                conditions:
                  - condition: zone
                    entity_id: person.daniel_boluda_fdez_gmail_com
                    zone: zone.mercadona
              - service: notify.mobile_app_daniel_boluda
                data:
                  title: "Lista de la compra"
                  message: "Lucía está en Mercadona. ¿Quieres añadir algo?"
                  data:
                    url: "/shopping-list"
                    clickAction: "/shopping-list"

          # Guardia nocturna Lucía
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'check_lucia_guardia' }}"
            sequence:
              - choose:
                  - conditions:
                      - condition: zone
                        entity_id: person.pizarroservanlucia_gmail_com
                        zone: zone.hospital_gomez_ulla
                    sequence:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: input_boolean.lucia_guardia_nocturna
                default:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.lucia_guardia_nocturna
