apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: zfs-grigri-nfs-driver-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: zfs-grigri-nfs-driver-config
    template:
      data:
        driver-config-file.yaml: |
          driver: zfs-generic-nfs

          sshConnection:
            host: grigri.grigri
            port: 22
            username: {{`{{ .user | toString }}`}}
            privateKey: {{`{{ .ssh_private_key | toYaml | indent 2 }}`}}

          zfs:
            cli:
              sudoEnabled: true
            # total volume name (zvol/<datasetParentName>/<pvc name>) length cannot exceed 63 chars
            # https://www.ixsystems.com/documentation/freenas/11.2-U5/storage.html#zfs-zvol-config-opts-tab
            # standard volume naming overhead is 46 chars
            # datasetParentName should therefore be 17 chars or less when using TrueNAS 12 or below
            datasetParentName: datasets/k8s/nfs/v
            detachedSnapshotsDatasetParentName: datasets/k8s/nfs/s

            datasetProperties:
              compression: lz4
              "grigri:description": {{ "{{`" }}{{`"{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"`}}{{ "`}}" }}
            datasetEnableQuotas: true
            datasetEnableReservation: false

          nfs:
            shareStrategy: "setDatasetProperties"
            shareStrategySetDatasetProperties:
              properties:
                sharenfs: "rw=@192.168.192.0/24,no_subtree_check,no_root_squash"
            shareHost: "grigri.grigri"
  data:
    - secretKey: user
      remoteRef:
        key: /zfs-grigri-nfs/user
        property: user
    - secretKey: ssh_private_key
      remoteRef:
        key: /zfs-grigri-nfs/user
        property: ssh_private_key
