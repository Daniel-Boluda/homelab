---
- name: Format "{{ item.dev_id }}"
  parted:
    device: "{{ item.dev_id }}"
    number: 1
    state: absent
  when: item.force_format | default(false)
  tags:
    - additional-disk

- name: Create a new primary partition in {{ item.dev_id }}
  parted:
    device: "{{ item.dev_id }}"
    label: gpt
    number: 1
    state: present
  tags:
    - additional-disk

- name: Create a ext4 filesystem on {{ item.dev_id }}1
  filesystem:
    fstype: ext4
    dev: "{{ item.dev_id }}-part1"
    force: "{{ item.force_format | default(false) }}"
  tags:
    - additional-disk

- name: Get UUID for partition
  command: blkid -s UUID -o value "{{ item.dev_id }}-part1"
  register: disk_blkid
  check_mode: no
  changed_when: false
  tags:
    - additional-disk

- name: Mount "{{ item.dev_id }}-part1" to {{ item.path }}
  mount:
    path: "{{ item.path }}"
    src: "UUID={{ disk_blkid.stdout }}"
    fstype: ext4
    opts: defaults,noatime
    state: mounted
  tags:
    - additional-disk
