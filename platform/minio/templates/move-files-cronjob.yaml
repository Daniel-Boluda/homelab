apiVersion: batch/v1
kind: CronJob
metadata:
  name: minio-move-files
spec:
  schedule: "0 */2 * * *"  # Runs every 2 hours
  concurrencyPolicy: Forbid  # Ensures only one job runs at a time
  successfulJobsHistoryLimit: 1  # Retain the last 1 successful jobs
  failedJobsHistoryLimit: 1      # Retain the last 1 failed jobs
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mc
            image: quay.io/minio/mc:RELEASE.2024-03-03T00-13-08Z-cpuv1
            env:
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-users
                  key: veleroUser
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-users
                  key: veleroPassword
            command: ["/bin/sh", "-c"]
            args:
            - >
              mc alias set source-minio http://minio.minio.svc:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY &&
              mc alias set dest-minio http://192.168.1.249:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY &&
              mc mv --recursive source-minio/velero dest-minio/velero
          restartPolicy: Never
