apiVersion: batch/v1
kind: CronJob
metadata:
  name: minio-move-files
spec:
  schedule: "0 */2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mc
            image: quay.io/minio/mc:RELEASE.2024-03-03T00-13-08Z-cpuv1
            env:
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-users
                  key: veleroUser
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-users
                  key: veleroPassword
            command: ["/bin/sh", "-c"]
            args:
            - >
              mc alias set source-minio http://minio.minio.svc:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY &&
              mc alias set dest-minio http://192.168.1.249:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY &&
              if mc ls source-minio/velero | sed '1d' | awk '{print $5}' | grep -q .; then
                mc mv --recursive source-minio/velero dest-minio/velero &&
                mc rm --recursive --force --dangerous source-minio/velero;
              else
                echo "No files found in source-minio/velero. Skipping move operation.";
              fi
          restartPolicy: Never