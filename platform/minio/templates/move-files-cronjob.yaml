apiVersion: batch/v1
kind: CronJob
metadata:
  name: minio-move-files
spec:
  schedule: "0 */24 * * *"  # Runs once every 24 hours
  concurrencyPolicy: Forbid  # Ensures only one job runs at a time
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mc
            image: quay.io/minio/mc:RELEASE.2024-03-03T00-13-08Z-cpuv1
            env:
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-users
                  key: veleroUser
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-users
                  key: veleroPassword
            command: ["/bin/sh", "-c"]
            args:
            - >
              mc alias set source-minio http://minio.minio.svc:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY &&
              mc alias set dest-minio http://192.168.1.249:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY &&
              files_to_move=$(mc ls source-minio/velero | grep -v '/$') &&
              if [ -n "$files_to_move" ]; then
                echo "Files to move:" &&
                echo "$files_to_move" &&
                mc mv --recursive source-minio/velero/* dest-minio/velero/;
              else
                echo "No files to move";
              fi
          restartPolicy: Never
